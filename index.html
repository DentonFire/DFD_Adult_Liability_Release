<script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)'
        });

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear(); // otherwise previous signature is drawn on top
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        document.getElementById('clear-signature').onclick = () => signaturePad.clear();

        // Auto-fill name fields
        const name1 = document.getElementById('name1');
        const name2 = document.getElementById('name2');
        const printedName = document.getElementById('printed-name');
        name1.addEventListener('input', () => {
            name2.value = name1.value;
            printedName.value = name1.value;
        });

        // Auto-fill today’s date
        const today = new Date();
        document.getElementById('day').value = today.getDate();
        document.getElementById('month').value = today.toLocaleString('default', { month: 'long });
        document.getElementById('year').value = today.getFullYear().toString().slice(-2);

        const { jsPDF } = window.jspdf;
        const loadingOverlay = document.getElementById('loading-overlay');
        const previewPanel = document.getElementById('preview-panel');

        async function prepareSignature() {
            if (signaturePad.isEmpty()) {
                alert("Please provide a signature.");
                return null;
            }
            if (!name1.value.trim() || !document.getElementById('exercise-description').value.trim()) {
                alert("Please fill in your name and exercise description.");
                return null;
            }

            const sigDataURL = signaturePad.toDataURL('image/png');
            const sigImg = document.createElement('img');
            sigImg.src = sigDataURL;
            sigImg.style.cssText = 'position:absolute; top:0; left:0; width:100%; height:100%;';

            const container = document.querySelector('.signature-pad-container');
            const canvasEl = document.getElementById('signature-pad');
            const clearBtn = document.getElementById('clear-signature');

            canvasEl.style.display = 'none';
            clearBtn.style.display = 'none';
            container.appendChild(sigImg);

            return { sigImg, canvasEl, clearBtn, container };
        }

        function cleanupSignature(state) {
            if (!state) return;
            state.canvasEl.style.display = 'block';
            state.clearBtn.style.display = 'block';
            state.container.removeChild(state.sigImg);
        }

        // PREVIEW
        document.getElementById('preview-btn').onclick = async () => {
            const state = await prepareSignature();
            if (!state) return;

            loadingOverlay.style.display = 'flex';
            previewPanel.innerHTML = '';
            previewPanel.style.display = 'block';

            try {
                const pages = document.querySelectorAll('#form-content .page');
                for (const page of pages) {
                    const canvas = await html2canvas(page, {
                        scale: 1.5,           // ← Much smaller but still crisp
                        useCORS: true,
                        backgroundColor: '#ffffff'
                    });
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL('image/jpeg', 0.95); // JPEG = smaller
                    img.style.cssText = 'width:100%; margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); border-radius:8px;';
                    previewPanel.appendChild(img);
                }
            } catch (e) {
                alert('Preview failed: ' + e.message);
            } finally {
                loadingOverlay.style.display = 'none';
                cleanupSignature(state);
            }
        };

        // DOWNLOAD — THIS IS THE FIXED PART
        document.getElementById('download-btn').onclick = async () => {
            const state = await prepareSignature();
            if (!state) return;

            loadingOverlay.style.display = 'flex';

            try {
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'in',
                    format: 'letter',
                    compress: true                    // ← Enable compression
                });

                const pages = document.querySelectorAll('#form-content .page');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];

                    const canvas = await html2canvas(page, {
                        scale: 2,                     // ← Perfect balance: crisp + small file
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 0.85); // JPEG + quality 85%

                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;

                    if (i > 0) pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, pdfHeight);
                }

                pdf.save('Denton-Adult-Liability-Release.pdf');
            } catch (e) {
                console.error(e);
                alert('PDF creation failed: ' + e.message);
            } finally {
                loadingOverlay.style.display = 'none';
                cleanupSignature(state);
            }
        };
    });
</script>
