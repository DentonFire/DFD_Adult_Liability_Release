<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City of Denton - Adult Liability Release</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            color: #333;
            -webkit-print-color-adjust: exact;
        }
        .container {
            max-width: 8.5in;
            margin: 32px auto;
        }
        .header {
            background-color: #152a40;
            color: #ffffff;
            text-align: center;
            padding: 32px;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }
        .footer {
            background-color: #152a40;
            color: #ffffff;
            text-align: center;
            padding: 32px;
            border-bottom-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
        }
        .page {
            background: white;
            padding: 0.5in 0.75in 1in 0.75in;
            margin: 0 auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            box-sizing: border-box;
            line-height: 1.5;
            margin-bottom: 20px;
        }
        .page-content p {
            font-size: 0.95rem;
            margin-bottom: 1em;
            text-align: justify;
        }
        .form-title {
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        .state-county {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        input[type="text"],
        input[type="tel"] {
            border: none;
            border-bottom: 1px solid #777;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            padding: 4px 2px;
            margin: 0 4px;
        }
        textarea {
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            padding: 8px;
            resize: vertical;
            min-height: 60px;
            margin-top: 5px;
        }
        .signature-area {
            margin-top: 2rem;
        }
        .signature-pad-container {
            border: 2px dashed #ccc;
            border-radius: 5px;
            position: relative;
            height: 150px;
        }
        #signature-pad {
            width: 100%;
            height: 100%;
        }
        #clear-signature {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #efefef;
            border: 1px solid #ccc;
            color: #555;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1rem;
        }
        .form-field {
            display: flex;
            flex-direction: column;
        }
        .form-field label {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .form-field input {
            width: 100%;
        }
        .download-section {
            background: white;
            padding: 32px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .download-btn {
            background-color: #bf2726;
            color: #fff;
            padding: 14px 28px;
            text-decoration: none;
            border-radius: 0.5rem;
            font-weight: 700;
            display: inline-block;
            font-size: 1.125rem;
            border: none;
            cursor: pointer;
            margin: 0 10px;
        }
        .preview-btn {
            background-color: #152a40;
        }
        #preview-panel {
            margin-top: 20px;
            background: #f9f9f9;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 16px;
            max-height: 600px;
            overflow-y: auto;
            display: none;
        }
        #preview-panel img {
            width: 100%;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #bf2726;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        
        /* --- NEW QR CODE & MODAL STYLES --- */
        .qr-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 900;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: rgba(21, 42, 64, 0.95); /* Navy */
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            transition: transform 0.2s, background-color 0.2s;
            color: white;
        }
        .qr-fab:hover {
            transform: scale(1.1);
            background-color: #152a40;
            border-color: #f9c031;
        }
        .qr-fab svg {
            width: 32px;
            height: 32px;
            stroke: currentColor;
            fill: none;
            stroke-width: 1.5;
        }
        .qr-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .qr-modal.active {
            display: flex;
        }
        .qr-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(21, 42, 64, 0.85);
            backdrop-filter: blur(4px);
            cursor: pointer;
        }
        .qr-modal-content {
            position: relative;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 340px;
            text-align: center;
            animation: modalFadeIn 0.2s ease-out;
            z-index: 2001;
            font-family: 'Inter', sans-serif;
        }
        .qr-modal-icon {
            width: 48px;
            height: 48px;
            background-color: rgba(21, 42, 64, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem auto;
            color: #152a40;
        }
        .qr-modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin: 0 0 0.5rem 0;
        }
        .qr-modal-text {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0 0 1rem 0;
        }
        .qr-image-container {
            border: 1px solid #e5e7eb;
            padding: 8px;
            border-radius: 8px;
            background: #f9fafb;
            display: inline-block;
        }
        .qr-modal-close {
            margin-top: 1.5rem;
            background-color: #fff;
            color: #111827;
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 0.875rem;
            transition: background 0.2s;
        }
        .qr-modal-close:hover {
            background-color: #f3f4f6;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media print {
            body { background: #fff; }
            .header, .footer, .download-section, #clear-signature, .qr-fab, .qr-modal { display: none !important; }
            .container { margin: 0; max-width: 100%; }
            .page { box-shadow: none; margin: 0; padding: 0.5in; page-break-after: always; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- QR Code Floating Button -->
    <div class="qr-fab" onclick="toggleQrModal()" title="Scan to open on mobile">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 13.5 9.375v-4.5Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75ZM6.75 16.5h.75v.75h-.75v-.75ZM16.5 6.75h.75v.75h-.75v-.75ZM13.5 13.5h.75v.75h-.75v-.75ZM13.5 19.5h.75v.75h-.75v-.75ZM19.5 13.5h.75v.75h-.75v-.75ZM19.5 19.5h.75v.75h-.75v-.75ZM16.5 16.5h.75v.75h-.75v-.75Z" />
        </svg>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="qr-modal">
        <div class="qr-modal-backdrop" onclick="toggleQrModal()"></div>
        <div class="qr-modal-content">
            <div class="qr-modal-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:24px;height:24px;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 13.5 9.375v-4.5Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75ZM6.75 16.5h.75v.75h-.75v-.75ZM16.5 6.75h.75v.75h-.75v-.75ZM13.5 13.5h.75v.75h-.75v-.75ZM13.5 19.5h.75v.75h-.75v-.75ZM19.5 13.5h.75v.75h-.75v-.75ZM19.5 19.5h.75v.75h-.75v-.75ZM16.5 16.5h.75v.75h-.75v-.75Z" />
                </svg>
            </div>
            <h3 class="qr-modal-title">Scan for Mobile Access</h3>
            <p class="qr-modal-text">Scan this code to open this form on your mobile device.</p>
            
            <div class="qr-image-container">
                <img id="qr-image" src="" alt="QR Code" style="width:200px;height:200px;mix-blend-mode:multiply;">
            </div>
            
            <button class="qr-modal-close" onclick="toggleQrModal()">Close</button>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header" data-html2canvas-ignore="true">
            <img src="https://files.constantcontact.com/3720c3fd901/10017eb4-f7d2-424d-92ed-c1b5424b9869.png" alt="Denton Fire Patch" style="height:145px;width:110px;margin-bottom:16px;" />
            <h1 style="font-size:2.25rem;line-height:2.5rem;font-weight:900;color:#f9c031;margin:0;">City of Denton</h1>
            <p style="font-size:1.125rem;margin-top:8px;color:#bf2726;font-weight:bold;">Adult Liability Release</p>
        </div>

        <div id="form-content">
            <!-- Page 1 -->
            <div class="page">
                <div class="page-content">
                    <h2 class="form-title">CITY OF DENTON RELEASE AND INDEMNIFICATION (Adult)</h2>
                    <div class="state-county"><span>THE STATE OF TEXAS</span><span>KNOW ALL MEN BY THESE PRESENTS:</span></div>
                    <div class="state-county"><span>COUNTY OF DENTON</span></div>
                    <p>I <input type="text" id="name1" placeholder="Full Name" style="width:300px;"> am over the age of 18 years of age and have, upon my own free will, requested to participate in a City of Denton Fire Department program/exercise (Exercise) as follows:
                        <textarea id="exercise-description" placeholder="Briefly describe the program or exercise you are participating in."></textarea>
                    </p>
                    <p>I fully understand the possible dangers of a firefighters/EMTs job and accept that I may be subjected to such dangers myself and that there is an assumption of all such risks by me by entering into this release and indemnification and by participating in the Exercise. I understand that the firefighters/EMTs I will be participating with are employees of the City of Denton, Texas ("City").</p>
                    <p>I, <input type="text" id="name2" placeholder="Full Name" style="width:300px;">, in consideration of being allowed by the City to participate in the Exercise, voluntarily and knowingly execute this release and indemnification with the express intention of effecting the extinguishment of any and all claims against the City, its officers, employees, agents, successors, assigns, sponsors and volunteers assisting in City activities which may result from the agreement as herein designated above.</p>
                    <p>I, with the intention of binding myself, my heirs, executors, administrators, and assigns, do hereby expressly release and discharge all claims, demands, actions, judgments, and executions which I ever had, or now have or may have, or which my heirs, executors, administrators, or assigns may have, or claim to have, against the City and/or its agents, officers, servants, successors, assigns, sponsors, volunteers, or employees, created by, or arising out of personal injuries, known or unknown, and injuries to property, real or personal, caused by or arising out of, that sequence of events which occur from the agreement as herein designated above, or which may arise directly or indirectly from the performance of or created by or arising out of my participation in the Exercise or this indemnity agreement AND INCLUDING, WITHOUT LIMITATION, CLAIMS AND DAMAGES ARISING IN WHOLE OR IN PART FROM THE NEGLIGENCE OF THE CITY, ITS EMPLOYEES, AGENTS, OFFICERS, SUCCESSORS, ASSIGNS, SPONSORS, AND VOLUNTEERS.</p>
                </div>
            </div>

            <!-- Page 2 -->
            <div class="page">
                <div class="page-content">
                    <p>Furthermore, I agree to indemnify and hold harmless the City and/or its officers, agents, servants, employees, successors, assigns, sponsors, or volunteers from any liabilities or damages I may suffer as a result of claims, demands, costs, or judgments against the City and/or its officers, agents, servants, or employees, created by, or arising out of the agreement herein designated above and from my participation in the Exercise. If the City and/or its agents, officers, servants, employees, successors, assigns, sponsors, or volunteers in the enforcement of any part of this indemnity agreement, shall incur necessary expenses, or become obligated to pay attorney's fees or court costs, I agree to reimburse the City and/or its agents, officers, servants, employees, successors, assigns, sponsors, or volunteers for such expenses, attorney's fees, or court costs within thirty days after receiving written notice from the City and/or its agents, servants, employees, successors, officers, sponsors, assigns, or volunteers of the incurring of such expenses, costs, or obligations.</p>
                    <p>Additionally, I shall fully defend, protect, indemnify, and hold harmless the City and/or its agents, officers, servants, employees, successors, assigns, sponsors, or volunteers from and against each and every claim, demand, or cause of action and any and all liability, damages, obligations, judgments, losses, fines, penalties, costs, fees, and expenses incurred in defense of the City and/or its agents, officers, servants, or employees, including, without limitation, personal injuries and death in connection therewith which may be made or asserted by myself, my agents, my successors, my assigns, or any third parties on account of, arising out of, or in any way incidental to or in connection with the performance of this agreement and from my participation in the Exercise, INCLUDING, BUT NOT LIMITED TO, CLAIMS AND DAMAGES ARISING IN WHOLE OR IN PART FROM THE NEGLIGENCE OF THE CITY AND/OR THE PARTIES TO THIS AGREEMENT. IT IS UNDERSTOOD AND AGREED THAT THE INDEMNITY PROVIDED FOR IN THIS SECTION IS AN INDEMNITY TO INDEMNIFY AND PROTECT THE CITY AND/OR ITS AGENTS, OFFICERS, SERVANTS, OR EMPLOYEES FROM THE CONSEQUENCES OF THE NEGLIGENCE OF THE CITY AND/OR ITS AGENTS, OFFICERS, SERVANTS, OR EMPLOYEES, WHETHER THAT NEGLIGENCE IS THE SOLE OR CONTRIBUTING CAUSE OF THE RESULTANT INJURY, DEATH, AND/OR DAMAGE.</p>
                </div>
            </div>

            <!-- Page 3 -->
            <div class="page">
                <div class="page-content">
                    <p>I further authorize the City employee or agent supervising this activity to secure medical care for me in the event of injury. I promise to assume liability for payment, and hold harmless the City, its officers, employees, sponsors, volunteers, or agents, of medical expenses arising from said medical care for said injury.</p>
                    <p>I hereby give the City the right to photograph, televise, film, and sound record my acts, appearances, and utterances of me and to use any descriptive words or names, including my name in conjunction therewith and without limit as to the time, to produce and reproduce the same or any part thereof by any method, and to use for any purpose which the City deems proper. All such photographs, films, and sound recordings shall be the exclusive property of the City, and I hereby relinquish all rights, title, title, and interest therein.</p>
                    <p>I further certify that any Personal Protective Equipment (PPE) that I provide and use in the Exercise meets or exceeds all applicable standards and is appropriate for the activities contemplated in the Exercise.</p>
                    <p>I, the undersigned, have read this release and indemnification and understand all its terms. I execute it voluntarily and with full knowledge of its significance.</p>
                    <p style="margin-top:2rem;">
                        SIGNED THIS THE <input type="text" id="day" placeholder="Day" style="width:40px;"> day of <input type="text" id="month" placeholder="Month" style="width:120px;">, 20<input type="text" id="year" placeholder="YY" style="width:40px;">.
                    </p>
                    <div class="signature-area">
                        <label style="font-weight:bold;">Signature:</label>
                        <div class="signature-pad-container">
                            <canvas id="signature-pad"></canvas>
                            <button id="clear-signature" type="button">Clear</button>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-field">
                            <label for="printed-name">Printed Name:</label>
                            <input type="text" id="printed-name" placeholder="Your Full Name">
                        </div>
                        <div class="form-field">
                            <label for="telephone">Telephone:</label>
                            <input type="tel" id="telephone" placeholder="(555) 555-5555">
                        </div>
                        <div class="form-field" style="grid-column:1/-1;">
                            <label for="address">Address:</label>
                            <input type="text" id="address" placeholder="123 Main St, City, State, ZIP">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="download-section" data-html2canvas-ignore="true">
            <button id="preview-btn" class="download-btn preview-btn">Preview</button>
            <button id="download-btn" class="download-btn">Download Completed Form</button>
            <div id="preview-panel"></div>
        </div>

        <!-- Footer -->
        <div class="footer" data-html2canvas-ignore="true">
            <h3 style="font-size:1.5rem;line-height:2rem;font-weight:700;color:#f9c031;margin:0;">Ready to Serve</h3>
            <p style="margin-top:8px;color:#D1D5DB;">Sign up for our <a href="https://lp.constantcontactpages.com/sl/NKeQbQ1/dentonfire" target="_blank" style="color:#f9c031;text-decoration:underline;">recruiting list</a> to learn more about career opportunities with the Denton Fire Department.</p>
            <div style="margin-top:16px;color:#9CA3AF;">
                <p style="margin:0;">Denton Fire Department</p>
                <p style="margin:0;">(940) 349-8848 | FireRecruiting@cityofdenton.com</p>
            </div>
        </div>
    </div>

    <!-- FIXED & OPTIMIZED SCRIPT -->
    <script>
        // QR Code Logic
        function toggleQrModal() {
            const modal = document.getElementById('qr-modal');
            const qrImage = document.getElementById('qr-image');
            
            modal.classList.toggle('active');

            if (modal.classList.contains('active')) {
                // Generate QR Code
                const targetUrl = 'https://dentonfire.github.io/DFD_Adult_Liability_Release/';
                qrImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(targetUrl)}`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('signature-pad');
            const signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255,255,255)',
                penColor: 'rgb(0,0,0)'
            });

            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signaturePad.clear();
            }
            window.addEventListener("resize", resizeCanvas);
            resizeCanvas();

            document.getElementById('clear-signature').onclick = () => signaturePad.clear();

            // Auto-fill name
            const name1 = document.getElementById('name1');
            const name2 = document.getElementById('name2');
            const printedName = document.getElementById('printed-name');
            name1.addEventListener('input', () => {
                name2.value = name1.value;
                printedName.value = name1.value;
            });

            // Auto-fill date — FIXED SYNTAX ERROR HERE
            const today = new Date();
            document.getElementById('day').value = today.getDate();
            document.getElementById('month').value = today.toLocaleString('default', { month: 'long' });
            document.getElementById('year').value = today.getFullYear().toString().slice(-2);

            const { jsPDF } = window.jspdf;
            const loadingOverlay = document.getElementById('loading-overlay');
            const previewPanel = document.getElementById('preview-panel');

            async function prepareSignature() {
                if (signaturePad.isEmpty()) {
                    alert("Please provide a signature.");
                    return null;
                }
                if (!name1.value.trim() || !document.getElementById('exercise-description').value.trim()) {
                    alert("Please fill in your name and exercise description.");
                    return null;
                }

                const sigDataURL = signaturePad.toDataURL('image/png');
                const sigImg = document.createElement('img');
                sigImg.src = sigDataURL;
                sigImg.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;';

                const container = document.querySelector('.signature-pad-container');
                const canvasEl = document.getElementById('signature-pad');
                const clearBtn = document.getElementById('clear-signature');

                canvasEl.style.display = 'none';
                clearBtn.style.display = 'none';
                container.appendChild(sigImg);

                return { sigImg, canvasEl, clearBtn, container };
            }

            function cleanupSignature(state) {
                if (!state) return;
                state.canvasEl.style.display = 'block';
                state.clearBtn.style.display = 'block';
                state.container.removeChild(state.sigImg);
            }

            // PREVIEW — NOW WORKS
            document.getElementById('preview-btn').onclick = async () => {
                const state = await prepareSignature();
                if (!state) return;

                loadingOverlay.style.display = 'flex';
                previewPanel.innerHTML = '';
                previewPanel.style.display = 'block';

                try {
                    const pages = document.querySelectorAll('#form-content .page');
                    for (const page of pages) {
                        const canvas = await html2canvas(page, { scale: 1.5, useCORS: true, backgroundColor: '#ffffff' });
                        const img = document.createElement('img');
                        img.src = canvas.toDataURL('image/jpeg', 0.95);
                        img.style.cssText = 'width:100%;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);border-radius:8px;';
                        previewPanel.appendChild(img);
                    }
                } catch (e) {
                    alert('Preview failed: ' + e.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                    cleanupSignature(state);
                }
            };

            // DOWNLOAD — ~400 KB & CRISP
            document.getElementById('download-btn').onclick = async () => {
                const state = await prepareSignature();
                if (!state) return;

                loadingOverlay.style.display = 'flex';

                try {
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'in',
                        format: 'letter',
                        compress: true
                    });

                    const pages = document.querySelectorAll('#form-content .page');
                    const pageWidth = pdf.internal.pageSize.getWidth();

                    for (let i = 0; i < pages.length; i++) {
                        const page = pages[i];

                        const canvas = await html2canvas(page, {
                            scale: 2,
                            useCORS: true,
                            backgroundColor: '#ffffff',
                            logging: false
                        });

                        const imgData = canvas.toDataURL('image/jpeg', 0.85);
                        const imgProps = pdf.getImageProperties(imgData);
                        const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;

                        if (i > 0) pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, pdfHeight);
                    }

                    pdf.save('Denton-Adult-Liability-Release.pdf');
                } catch (e) {
                    console.error(e);
                    alert('PDF creation failed: ' + e.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                    cleanupSignature(state);
                }
            };
        });
    </script>
</body>
</html>
